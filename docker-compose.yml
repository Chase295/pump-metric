services:
  tracker:
    build:
      context: ./tracker
      dockerfile: Dockerfile
    container_name: pump-metric-tracker
    restart: unless-stopped
    environment:
      - DB_DSN=${DB_DSN:-postgresql://postgres:9HVxi6hN6j7xpmqUx84o@100.118.155.75:5432/crypto}
      - WS_URI=${WS_URI:-wss://pumpportal.fun/api/data}
      - DB_REFRESH_INTERVAL=${DB_REFRESH_INTERVAL:-10}
      - SOL_RESERVES_FULL=${SOL_RESERVES_FULL:-85.0}
      - AGE_CALCULATION_OFFSET_MIN=${AGE_CALCULATION_OFFSET_MIN:-60}
      - TRADE_BUFFER_SECONDS=${TRADE_BUFFER_SECONDS:-180}
      - DB_RETRY_DELAY=${DB_RETRY_DELAY:-5}
      - WS_RETRY_DELAY=${WS_RETRY_DELAY:-3}
      - WS_MAX_RETRY_DELAY=${WS_MAX_RETRY_DELAY:-60}
      - WS_PING_INTERVAL=${WS_PING_INTERVAL:-20}
      - WS_PING_TIMEOUT=${WS_PING_TIMEOUT:-10}
      - WS_CONNECTION_TIMEOUT=${WS_CONNECTION_TIMEOUT:-30}
      - HEALTH_PORT=${HEALTH_PORT:-8000}
    ports:
      # API & Metrics Port (Health-Check + Prometheus Metrics)
      # Externer Port: ${TRACKER_PORT:-8011} → Interner Port: 8000
      # Endpoints: http://<SERVER_IP>:${TRACKER_PORT}/health und http://<SERVER_IP>:${TRACKER_PORT}/metrics
      # Von extern erreichbar auf Port 8011
      - "0.0.0.0:${TRACKER_PORT:-8011}:8000"
    volumes:
      - ./config:/app/config:ro
    networks:
      - pump-metric-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: pump-metric-ui
    restart: unless-stopped
    environment:
      - TRACKER_SERVICE=tracker
      - TRACKER_PORT=8000
    ports:
      # Streamlit UI Port
      # Externer Port: ${UI_PORT:-8501} → Interner Port: 8501
      # URL: http://<SERVER_IP>:${UI_PORT}
      # Von extern erreichbar
      - "0.0.0.0:${UI_PORT:-8501}:8501"
    volumes:
      - ./config:/app/config:rw
      - ./.env:/app/.env:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - pump-metric-network
    depends_on:
      - tracker

networks:
  pump-metric-network:
    driver: bridge

volumes:
  config:

